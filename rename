- name: Получить IP ВМ из Proxmox
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Получить IP VM 201-210
      community.proxmox.proxmox:
        api_user: root@pam
        api_password: "Пароль"
        api_host: 172.16.10.5
        vmid: "{{ item }}"
        node: px03
        guest_agent: yes
      loop: "{{ range(201,211) | list }}"
      register: vm_info

# Сюда формируется inventory для Windows хостов по vm_info.results

- name: Переименовать Windows ВМ
  hosts: windows
  gather_facts: no
  tasks:
    - name: Переименовать машину
      ansible.windows.win_hostname:
        name: "PC{{ item.vmid }}"
        reboot: yes
      loop: "{{ vm_info.results }}"
