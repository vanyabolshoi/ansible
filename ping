---
- name: Проверка доступности Windows-хостов с подсчетом
  hosts: windows
  gather_facts: no
  tasks:
    - name: Проверка WinRM доступности
      win_ping:
      register: winrm_result
      ignore_errors: yes

    - name: Добавить факт с успешностью WinRM
      set_fact:
        winrm_success: "{{ (winrm_result is defined and winrm_result.ping is defined) | ternary(1, 0) }}"

    - name: Собрать успешные хосты в переменную
      set_fact:
        successful_hosts: "{{ (successful_hosts | default([])) + [inventory_hostname] if winrm_success == 1 else successful_hosts | default([]) }}"

  post_tasks:
    - name: Вывести итог по количеству хостов
      debug:
        msg: >
          Общее количество IP: {{ groups['windows'] | length }},
          Успешно отвечают: {{ successful_hosts | default([]) | length }},
          Не отвечают: {{ (groups['windows'] | length | int) - (successful_hosts | default([]) | length) }}
