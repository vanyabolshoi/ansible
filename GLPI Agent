---
- name: Install and configure GLPI Agent
  hosts: windows
  gather_facts: no
  tasks:
    - name: Download GLPI-Agent MSI
      win_get_url:
        url: "https://github.com/vanyabolshoi/ansible/raw/main/GLPI-Agent-1.15-x64.msi"
        dest: "C:\\Temp\\GLPI-Agent-1.15-x64.msi"

    - name: Install GLPI-Agent for all users (visible)
      win_package:
        path: "C:\\Temp\\GLPI-Agent-1.15-x64.msi"
        state: present
        arguments: '/quiet ALLUSERS=1 DISPLAYLEVEL=0'

    - name: Configure GLPI-Agent server via batch
      win_command: >
        "C:\\Program Files\\GLPI-Agent\\glpi-agent.bat"
        --server http://172.16.10.234:7932/marketplace/glpiinventory/
      args:
        chdir: "C:\\Program Files\\GLPI-Agent"

    - name: Set GLPI-Agent server URL in registry
      ansible.windows.win_shell: |
        $regPath = "HKLM:\SOFTWARE\GLPI-Agent"
        $regName = "server"
        $regValue = "http://172.16.10.234:7932/marketplace/glpiinventory/"
        if (-not (Test-Path $regPath)) { New-Item -Path $regPath -Force | Out-Null }
        Set-ItemProperty -Path $regPath -Name $regName -Value $regValue -Type String

    - name: Enable GLPI-Agent service autostart
      win_service:
        name: GLPI-Agent
        start_mode: auto

    - name: Start GLPI-Agent service
      win_service:
        name: GLPI-Agent
        state: started

    - name: Force first inventory (debug mode)
      win_command: >
        "C:\\Program Files\\GLPI-Agent\\glpi-agent.bat"
        --server http://172.16.10.234:7932/marketplace/glpiinventory/
        --tasks Inventory,RemoteInventory
        --debug
      args:
        chdir: "C:\\Program Files\\GLPI-Agent"
