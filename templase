---
- name: Create 3 linked clones from Windows template in Proxmox
  hosts: localhost
  gather_facts: false
  vars:
    vm_template_name: win-template
    node: px02
    clone_base_name: template
    clone_start_id: 904
    clone_count: 3

  tasks:
    - name: Generate list of VMs to create
      set_fact:
        vm_list: "{{ lookup('sequence', start=clone_start_id, count=clone_count, format='%d') | map('int') | list }}"

    - name: Clone Windows VM as linked clones
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ ansible_user }}"
        api_password: "{{ ansible_password }}"
        vmid: "{{ item }}"
        name: "{{ clone_base_name }}{{ item - clone_start_id + 4 }}"
        node: "{{ node }}"
        clone: "{{ vm_template_name }}"
        full: no
        state: present
        timeout: 300
      loop: "{{ vm_list }}"
