---
- name: Проверка доступности WinRM на Windows-хостах
  hosts: windows
  gather_facts: false
  tasks:

    - name: Проверить доступность WinRM
      win_ping:
      register: ping_result
      ignore_errors: yes

    - name: Пометить хосты reachable/unreachable (локально)
      set_fact:
        winrm_status: "{{ 'reachable' if ping_result is succeeded else 'unreachable' }}"

    - name: Сбор данных о статусе по всем хостам (локально)
      run_once: true
      delegate_to: localhost
      vars:
        reachable_hosts: "{{ groups['windows'] | select('match', '.*') | select('extract', hostvars, 'winrm_status') | select('equalto', 'reachable') | list }}"
        unreachable_hosts: "{{ groups['windows'] | select('match', '.*') | select('extract', hostvars, 'winrm_status') | select('equalto', 'unreachable') | list }}"
      debug:
        msg:
          - "Доступен WinRM на хостах: {{ reachable_hosts }}"
          - "WinRM недоступен на хостах: {{ unreachable_hosts }}"
