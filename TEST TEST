---
- name: Проверка доступности Windows-хостов
  hosts: windows
  gather_facts: no
  tasks:
    - name: Проверка ICMP
      win_shell: Test-Connection -ComputerName $env:COMPUTERNAME -Count 1 -Quiet
      register: icmp_check
      ignore_errors: yes

    - name: Проверка WinRM
      win_ping:
      register: winrm_check
      ignore_errors: yes
      when: icmp_check.rc == 0 or icmp_check.stdout == "True"

    - name: Присвоить статус
      set_fact:
        status: >-
          {% if winrm_check is defined and winrm_check.ping == "pong" %}
            reachable
          {% elif icmp_check.rc == 0 or icmp_check.stdout == "True" %}
            no_manage
          {% else %}
            unreachable
          {% endif %}

- name: Классификация хостов по статусам
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Собрать статусы reachable-хостов
      set_fact:
        host_statuses: >-
          {{
            groups['windows']
            | map('extract', hostvars, 'status')
            | zip(groups['windows'])
            | items2dict(key_name=1, value_name=0)
          }}

    - name: Добавить unreachable хосты (без статуса)
      set_fact:
        host_statuses: >-
          {{
            host_statuses
            | combine(
                dict(
                  (item, 'unreachable') for item in groups['windows'] if item not in host_statuses
                )
              )
          }}

    - name: Получить списки IP по статусам
      set_fact:
        reachable_hosts: "{{ host_statuses | dict2items | selectattr('value', 'equalto', 'reachable') | map(attribute='key') | list }}"
        no_manage_hosts: "{{ host_statuses | dict2items | selectattr('value', 'equalto', 'no_manage') | map(attribute='key') | list }}"
        unreachable_hosts: "{{ host_statuses | dict2items | selectattr('value', 'equalto', 'unreachable') | map(attribute='key') | list }}"

    - name: Вывести результаты
      debug:
        msg: |
          Reachable (WinRM OK): {{ reachable_hosts | join(', ') }}
          No manage (Ping OK, WinRM FAIL): {{ no_manage_hosts | join(', ') }}
          Unreachable (No Ping): {{ unreachable_hosts | join(', ') }}
