---
- name: Проверка доступности Windows-хостов
  hosts: windows
  gather_facts: no
  vars:
    ansible_winrm_server_cert_validation: ignore
  tasks:
    - name: Проверка ICMP (ping) с localhost к хосту
      delegate_to: localhost
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 5985
        timeout: 3
      register: icmp_check
      ignore_errors: yes

    - name: Проверка WinRM
      win_ping:
      register: winrm_check
      ignore_errors: yes

    - name: Присвоить статус
      set_fact:
        status: >-
          {% if winrm_check is defined and winrm_check.ping == "pong" %}
            reachable
          {% elif icmp_check is defined and icmp_check.elapsed is defined %}
            no_manage
          {% else %}
            unreachable
          {% endif %}
      cacheable: yes  # Важно, чтобы статус остался доступен для следующего play

- name: Классификация хостов по статусам
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Собрать статусы хостов
      set_fact:
        host_statuses: >-
          {{
            groups['windows']
            | map('extract', hostvars, 'status')
            | zip(groups['windows'])
            | map('reverse')
            | items2dict()
          }}

    - name: Вывести списки по статусам
      debug:
        msg: |
          Reachable (WinRM OK): {{ host_statuses | dict2items | selectattr('value', 'equalto', 'reachable') | map(attribute='key') | list | join(', ') }}
          No manage (Ping OK, WinRM FAIL): {{ host_statuses | dict2items | selectattr('value', 'equalto', 'no_manage') | map(attribute='key') | list | join(', ') }}
          Unreachable (No Ping): {{ host_statuses | dict2items | selectattr('value', 'equalto', 'unreachable') | map(attribute='key') | list | join(', ') }}
