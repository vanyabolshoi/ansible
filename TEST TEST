---
- name: Проверка доступности WinRM на Windows хостах
  hosts: windows
  gather_facts: no
  vars:
    failed_hosts: []

  tasks:
    - name: Проверить доступность WinRM (win_ping)
      win_ping:
      register: ping_result
      ignore_unreachable: yes
      ignore_errors: yes

    - name: Добавить хост в список failed_hosts, если unreachable или failed
      set_fact:
        failed_hosts: "{{ failed_hosts + [inventory_hostname] }}"
      when: ping_result is failed or ping_result is unreachable

    - name: Вывести список хостов, где не прошла проверка WinRM
      debug:
        msg: "WinRM недоступен на хостах: {{ failed_hosts }}"
      run_once: true
