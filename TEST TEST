- hosts: windows
  gather_facts: no
  vars:
    failed_hosts: []

  tasks:
    - name: Проверка WinRM с обработкой ошибок
      block:
        - win_ping:
      rescue:
        - set_fact:
            failed_hosts: "{{ failed_hosts + [inventory_hostname] }}"

    - name: Вывести список хостов, где не прошла проверка WinRM
      debug:
        msg: "WinRM недоступен на хостах: {{ failed_hosts }}"
      run_once: true
