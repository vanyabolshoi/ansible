---
- name: Проверка доступности Windows-хостов
  hosts: windows
  gather_facts: no
  tasks:
    - name: Проверка ICMP (ping)
      ansible.builtin.ping:
      register: icmp_check
      ignore_errors: yes

    - name: Проверка WinRM (ping через winrm)
      ansible.windows.win_ping:
      register: winrm_check
      ignore_errors: yes

    - name: Присвоить статус
      set_fact:
        status: >-
          {% if winrm_check is defined and winrm_check.ping == "pong" %}
            reachable
          {% elif icmp_check is defined and icmp_check.ping is defined %}
            no_manage
          {% else %}
            unreachable
          {% endif %}

    - name: Добавить хост с атрибутом статуса в группу checked_hosts
      add_host:
        name: "{{ inventory_hostname }}"
        groups: checked_hosts
        status: "{{ status }}"

- name: Классификация хостов по статусам и вывод списков
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Собрать статусы хостов в словарь host_statuses
      set_fact:
        host_statuses: >-
          {{
            dict(
              groups['checked_hosts'] | zip(
                groups['checked_hosts'] | map('extract', hostvars, 'status')
              )
            )
          }}

    - name: Вывести списки хостов по статусам
      debug:
        msg: |
          Reachable (WinRM OK): {{ host_statuses | dict2items | selectattr('value', 'equalto', 'reachable') | map(attribute='key') | list | join(', ') | default('нет') }}
          No manage (Ping OK, WinRM FAIL): {{ host_statuses | dict2items | selectattr('value', 'equalto', 'no_manage') | map(attribute='key') | list | join(', ') | default('нет') }}
          Unreachable (No Ping): {{ host_statuses | dict2items | selectattr('value', 'equalto', 'unreachable') | map(attribute='key') | list | join(', ') | default('нет') }}
