- name: Проверка Windows хостов
  hosts: windows
  gather_facts: no
  tasks:
    - name: Проверка ICMP
      ansible.builtin.ping:
      register: icmp_check
      ignore_errors: yes

    - name: Проверка WinRM
      ansible.windows.win_ping:
      register: winrm_check
      ignore_errors: yes

    - name: Определение статуса
      set_fact:
        status: >-
          {% if winrm_check is defined and winrm_check.ping == "pong" %}
            reachable
          {% elif icmp_check is defined and icmp_check.ping is defined %}
            no_manage
          {% else %}
            unreachable
          {% endif %}

    - name: Debug статус
      debug:
        msg: "Хост {{ inventory_hostname }} - статус {{ status }}"

    - name: Добавить хост с атрибутом статуса в checked_hosts
      add_host:
        name: "{{ inventory_hostname }}"
        groups: checked_hosts
        status: "{{ status }}"

- name: Вывод по статусам
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Debug группы checked_hosts
      debug:
        var: groups['checked_hosts']

    - name: Собрать словарь статусов
      set_fact:
        host_statuses: >-
          {{
            dict(
              groups['checked_hosts'] | zip(
                groups['checked_hosts'] | map('extract', hostvars, 'status')
              )
            )
          }}

    - name: Debug статусов
      debug:
        var: host_statuses

    - name: Вывести списки по статусам
      debug:
        msg: |
          Reachable: {{ host_statuses | dict2items | selectattr('value', 'equalto', 'reachable') | map(attribute='key') | list | join(', ') | default('нет') }}
          No manage: {{ host_statuses | dict2items | selectattr('value', 'equalto', 'no_manage') | map(attribute='key') | list | join(', ') | default('нет') }}
          Unreachable: {{ host_statuses | dict2items | selectattr('value', 'equalto', 'unreachable') | map(attribute='key') | list | join(', ') | default('нет') }}
