- name: Проверка Windows хостов
  hosts: windows
  gather_facts: no
  tasks:
    - name: Проверка ICMP (ping)
      ansible.builtin.ping:
      register: icmp_check
      ignore_errors: yes

    - name: Проверка WinRM (win_ping)
      ansible.windows.win_ping:
      register: winrm_check
      ignore_errors: yes

    - name: Определение статуса
      set_fact:
        status: >-
          {% if winrm_check is defined and winrm_check.ping == "pong" %}
            reachable
          {% elif icmp_check is defined and icmp_check.ping is defined %}
            no_manage
          {% else %}
            unreachable
          {% endif %}

- name: Сбор и вывод IP по статусам
  hosts: localhost
  gather_facts: no
  vars:
    reachable_ips: []
    no_manage_ips: []
    unreachable_ips: []
  tasks:
    - name: Получить список всех хостов из группы windows
      set_fact:
        all_hosts: "{{ groups['windows'] }}"

    - name: Собрать IP по статусам
      set_fact:
        reachable_ips: "{{ reachable_ips + [item] }}"
      when: hostvars[item].status is defined and hostvars[item].status == 'reachable'
      loop: "{{ all_hosts }}"

    - name: Собрать IP no_manage
      set_fact:
        no_manage_ips: "{{ no_manage_ips + [item] }}"
      when: hostvars[item].status is defined and hostvars[item].status == 'no_manage'
      loop: "{{ all_hosts }}"

    - name: Собрать IP unreachable
      set_fact:
        unreachable_ips: "{{ unreachable_ips + [item] }}"
      when: hostvars[item].status is defined and hostvars[item].status == 'unreachable'
      loop: "{{ all_hosts }}"

    - name: Вывести списки IP
      debug:
        msg: |
          Reachable: {{ reachable_ips | join(', ') | default('нет') }}
          No manage: {{ no_manage_ips | join(', ') | default('нет') }}
          Unreachable: {{ unreachable_ips | join(', ') | default('нет') }}
