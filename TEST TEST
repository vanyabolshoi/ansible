---
- name: Проверка доступности Windows-хостов и WinRM
  hosts: localhost
  gather_facts: no
  vars:
    winrm_hosts: "{{ groups['windows'] if 'windows' in groups else [] }}"

  tasks:
    - name: Проверка доступности по TCP 5986 (WinRM)
      wait_for:
        host: "{{ item }}"
        port: 5986
        timeout: 3
      register: winrm_port_check
      ignore_errors: yes
      loop: "{{ winrm_hosts }}"

    - name: Проверка доступности по ping (ICMP)
      ansible.builtin.ping:
      delegate_to: "{{ item }}"
      register: ping_results
      ignore_errors: yes
      loop: "{{ winrm_hosts }}"

    - name: DEBUG ping_results
      debug:
        var: ping_results

    - name: DEBUG winrm_port_check
      debug:
        var: winrm_port_check

    - name: Сформировать списки
      set_fact:
        reachable_hosts: "{{ ping_results.results | selectattr('failed', 'equalto', false) | map(attribute='item') | list }}"
        unreachable_hosts: "{{ ping_results.results | selectattr('failed', 'equalto', true) | map(attribute='item') | list }}"
        winrm_open_hosts: "{{ winrm_port_check.results | selectattr('state', 'equalto', 'started') | map(attribute='item') | list }}"
        winrm_closed_hosts: "{{ winrm_port_check.results | selectattr('state', 'ne', 'started') | map(attribute='item') | list }}"

    - name: Проверить WinRM на reachable и с открытым портом 5986
      win_command: hostname
      delegate_to: "{{ item }}"
      register: winrm_check_results
      ignore_errors: yes
      loop: "{{ reachable_hosts | intersect(winrm_open_hosts) }}"

    - name: Сформировать финальные списки
      set_fact:
        winrm_ok: "{{ winrm_check_results.results | selectattr('failed', 'equalto', false) | map(attribute='item') | list }}"
        winrm_fail: "{{ winrm_check_results.results | selectattr('failed', 'equalto', true) | map(attribute='item') | list }}"

    - name: Вывести результаты
      debug:
        msg: |
          Полностью рабочий WinRM: {{ winrm_ok }}
          Узлы доступны (ping), но WinRM не отвечает: {{ winrm_fail + winrm_closed_hosts | unique }}
          Узлы недоступны (ping не проходит): {{ unreachable_hosts }}
