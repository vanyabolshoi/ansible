---
- name: Проверка доступности WinRM и деление на группы
  hosts: localhost
  gather_facts: no
  vars:
    ip_list:
      - 192.168.1.10
      - 192.168.1.20
      - 192.168.1.30

  tasks:

    - name: Проверить доступность узлов по ping (ICMP)
      ansible.builtin.ping:
      delegate_to: "{{ item }}"
      register: ping_results
      ignore_errors: yes
      loop: "{{ ip_list }}"

    - name: Сформировать список доступных по ping узлов
      set_fact:
        reachable_ips: "{{ ping_results.results | selectattr('failed', 'equalto', false) | map(attribute='item') | list }}"
        unreachable_ips: "{{ ping_results.results | selectattr('failed', 'equalto', true) | map(attribute='item') | list }}"

    - name: Проверить доступность WinRM на reachable_ips
      win_command: hostname
      delegate_to: "{{ item }}"
      register: winrm_results
      ignore_errors: yes
      loop: "{{ reachable_ips }}"

    - name: Сформировать список узлов с доступным WinRM
      set_fact:
        winrm_ok: "{{ winrm_results.results | selectattr('failed', 'equalto', false) | map(attribute='item') | list }}"
        winrm_failed: "{{ winrm_results.results | selectattr('failed', 'equalto', true) | map(attribute='item') | list }}"

    - name: Вывести результаты
      debug:
        msg: |
          Доступные по WinRM: {{ winrm_ok }}
          Доступные по ping, но WinRM не работает: {{ winrm_failed }}
          Недоступные по ping: {{ unreachable_ips }}
