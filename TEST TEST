- name: Проверка доступности WinRM на Windows-хостах
  hosts: windows
  gather_facts: no
  tasks:
    - name: Проверить доступность порта 5986
      win_shell: Test-NetConnection -ComputerName "{{ inventory_hostname }}" -Port 5986
      register: port_check
      ignore_errors: yes

    - name: Проверить доступность WinRM
      win_ping:
      when: port_check.rc == 0 and port_check.stdout | search("TcpTestSucceeded : True")
      register: winrm_check
      ignore_errors: yes

    - name: Установить статус WinRM
      set_fact:
        winrm_status: "{{ 'reachable' if (winrm_check is defined and winrm_check.ping is defined) else 'unreachable' }}"

    - name: Вывести статус WinRM
      debug:
        msg: "WinRM status for {{ inventory_hostname }}: {{ winrm_status }}"
