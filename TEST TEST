- hosts: windows
  gather_facts: no
  vars:
    failed_hosts: []

  tasks:
    - block:
        - name: Проверить доступность WinRM (win_ping)
          win_ping:

      rescue:
        - name: Добавить хост в список failed_hosts из rescue
          set_fact:
            failed_hosts: "{{ failed_hosts + [inventory_hostname] }}"

    - name: Вывести список хостов, где не прошла проверка WinRM
      debug:
        msg: "WinRM недоступен на хостах: {{ failed_hosts }}"
      run_once: true
