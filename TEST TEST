---
- name: Проверка доступности WinRM на Windows-хостах
  hosts: windows
  gather_facts: false
  vars:
    reachable: []
    unreachable: []

  tasks:

    - name: Проверить доступность WinRM
      win_ping:
      register: ping_result
      ignore_errors: yes

    - name: Собрать reachable
      set_fact:
        reachable: "{{ reachable + [inventory_hostname] }}"
      when: ping_result is succeeded

    - name: Собрать unreachable
      set_fact:
        unreachable: "{{ unreachable + [inventory_hostname] }}"
      when: ping_result is failed

    - name: Вывести список reachable
      debug:
        msg: "Доступен WinRM на хостах: {{ reachable }}"
      run_once: true
      delegate_to: localhost

    - name: Вывести список unreachable
      debug:
        msg: "WinRM недоступен на хостах: {{ unreachable }}"
      run_once: true
      delegate_to: localhost
