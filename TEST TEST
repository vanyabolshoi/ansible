---
- name: Проверка доступности WinRM на Windows-хостах
  hosts: windows
  gather_facts: no
  vars:
    ansible_user: admin
    ansible_password: Pharmacia_
    ansible_connection: winrm
    ansible_winrm_transport: ntlm
    ansible_winrm_server_cert_validation: ignore
    ansible_port: 5986

  tasks:
    - name: Проверить доступность WinRM
      win_ping:
      register: winrm_check
      ignore_errors: yes

    - name: Отправить статус WinRM в localhost
      local_action:
        module: set_fact
        host_winrm_status: "{{ 'reachable' if winrm_check.ping is defined else 'unreachable' }}"
      delegate_to: localhost
      run_once: false

    - name: Сохранить статус в переменную хоста
      set_fact:
        winrm_status: "{{ 'reachable' if winrm_check.ping is defined else 'unreachable' }}"

- name: Сбор и вывод результатов на localhost
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Собрать reachable hosts
      set_fact:
        reachable_hosts: >-
          {{ groups['windows']
             | select('extract', hostvars, 'winrm_status')
             | select('equalto', 'reachable')
             | list }}

    - name: Собрать unreachable hosts
      set_fact:
        unreachable_hosts: >-
          {{ groups['windows']
             | select('extract', hostvars, 'winrm_status')
             | select('equalto', 'unreachable')
             | list }}

    - name: Вывести reachable hosts
      debug:
        msg: "Доступен WinRM на хостах: {{ reachable_hosts }}"

    - name: Вывести unreachable hosts
      debug:
        msg: "WinRM недоступен на хостах: {{ unreachable_hosts }}"
