- name: Проверка доступности WinRM на Windows-хостах
  hosts: windows
  gather_facts: no
  tasks:
    - name: Проверить доступность порта 5986
      wait_for:
        port: 5986
        host: "{{ inventory_hostname }}"
        timeout: 3
      register: port_check
      ignore_errors: yes

    - name: Проверить доступность WinRM
      win_ping:
      when: port_check is succeeded
      register: winrm_check
      ignore_errors: yes

    - name: Установить статус WinRM
      set_fact:
        winrm_status: "{{ 'reachable' if (winrm_check is defined and winrm_check.ping is defined) else 'unreachable' }}"
