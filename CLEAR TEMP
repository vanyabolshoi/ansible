---
- name: Clear TEMP folders for all users on Windows (skip locked files)
  hosts: all
  gather_facts: no
  tasks:

    - name: Create BAT file to clear TEMP folders
      win_copy:
        dest: C:\Windows\Temp\clear_all_users_temp.bat
        content: |
          @echo off
          setlocal EnableDelayedExpansion

          echo ================================
          echo Clearing TEMP folders for all users
          echo ================================

          :: Process all user profiles
          for /d %%U in (C:\Users\*) do (
              set USERPATH=%%U
              echo -------------------------------
              echo Clearing profile: %%U

              call :CleanFolder %%U\AppData\Local\Temp
              call :CleanFolder %%U\AppData\Local\Microsoft\Windows\INetCache
              call :CleanFolder %%U\AppData\Local\Microsoft\Windows\Temporary Internet Files
          )

          echo Clearing system TEMP...
          call :CleanFolder C:\Windows\Temp

          echo Done
          exit

          :CleanFolder
          set FOLDER=%~1

          if exist "%FOLDER%" (
              echo Clearing %FOLDER%

              :: Remove read-only, hidden, system attributes
              attrib -r -s -h "%FOLDER%\*" /s /d >nul 2>&1

              :: Delete files (skip locked files)
              for %%F in ("%FOLDER%\*") do (
                  del /f /q "%%F" >nul 2>&1
              )

              :: Delete folders (skip locked folders)
              for /d %%D in ("%FOLDER%\*") do (
                  rd /s /q "%%D" >nul 2>&1
              )
          )
          exit /b

    - name: Run BAT file
      win_shell: C:\Windows\Temp\clear_all_users_temp.bat

    - name: Remove temporary BAT file
      win_file:
        path: C:\Windows\Temp\clear_all_users_temp.bat
        state: absent
