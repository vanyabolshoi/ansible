---
- name: Find old users and show system update cache size
  hosts: windows
  gather_facts: no

  tasks:

    - name: Get old user folders with individual size
      win_shell: |
        $limitDate = Get-Date "2024-01-01"
        $exclude = @('Public','Default','Default User','All Users','Administrator')

        Get-ChildItem C:\Users -Directory |
        Where-Object {
            $_.Name -notin $exclude -and
            $_.LastWriteTime -lt $limitDate
        } |
        ForEach-Object {

            $folder = $_.FullName
            $result = robocopy $folder NULL /L /S /BYTES /NJH /NJS /NFL /NDL 2>$null

            $bytes = 0
            foreach ($line in $result) {
                if ($line -match "Bytes :\s+(\d+)") {
                    $bytes = [int64]$matches[1]
                }
            }

            [PSCustomObject]@{
                Type       = "UserProfile"
                Name       = $_.Name
                Path       = $folder
                LastWrite  = $_.LastWriteTime
                SizeGB     = "{0:N2}" -f ($bytes / 1GB)
            }
        }

      register: old_users

    - name: Get SoftwareDistribution Download size
      win_shell: |
        $folder = "C:\Windows\SoftwareDistribution\Download"

        if (Test-Path $folder) {

            $result = robocopy $folder NULL /L /S /BYTES /NJH /NJS /NFL /NDL 2>$null

            $bytes = 0
            foreach ($line in $result) {
                if ($line -match "Bytes :\s+(\d+)") {
                    $bytes = [int64]$matches[1]
                }
            }

            [PSCustomObject]@{
                Type      = "WindowsUpdateCache"
                Name      = "SoftwareDistribution"
                Path      = $folder
                LastWrite = (Get-Item $folder).LastWriteTime
                SizeGB    = "{0:N2}" -f ($bytes / 1GB)
            }
        }

      register: wu_cache

    - name: Show results
      debug:
        msg: |
          ==== OLD USER PROFILES ====
          {{ old_users.stdout }}

          ==== WINDOWS UPDATE CACHE ====
          {{ wu_cache.stdout }}
