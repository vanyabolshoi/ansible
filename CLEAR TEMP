---
- name: Очистка TEMP всех пользователей на Windows (без закрытия приложений)
  hosts: all
  gather_facts: no
  tasks:

    - name: Создать BAT файл для очистки TEMP всех пользователей
      win_copy:
        dest: C:\Windows\Temp\clear_all_users_temp.bat
        content: |
          @echo off
          setlocal EnableDelayedExpansion

          echo ================================
          echo  Очистка TEMP всех пользователей
          echo ================================

          echo.
          echo Обработка профилей пользователей...

          for /d %%U in (C:\Users\*) do (
              echo -------------------------------
              echo Очистка профиля: %%U

              call :CleanFolder "%%U\AppData\Local\Temp"
              call :CleanFolder "%%U\AppData\Local\Microsoft\Windows\INetCache"
              call :CleanFolder "%%U\AppData\Local\Microsoft\Windows\Temporary Internet Files"
          )

          echo.
          echo Очистка системного TEMP...
          call :CleanFolder "C:\Windows\Temp"

          echo.
          echo Готово.
          exit /b 0

          :CleanFolder
          set FOLDER=%~1

          if exist "%FOLDER%" (
              echo Очистка %FOLDER%

              :: Снимаем атрибуты
              attrib -r -s -h "%FOLDER%\*" /s /d >nul 2>&1

              :: Удаляем файлы, пропуская занятые
              for %%F in ("%FOLDER%\*") do (
                  del /f /q "%%F" >nul 2>&1
              )

              :: Удаляем подпапки, пропуская занятые
              for /d %%D in ("%FOLDER%\*") do (
                  rd /s /q "%%D" >nul 2>&1
              )
          )

          exit /b 0

    - name: Запустить BAT файл
      win_shell: C:\Windows\Temp\clear_all_users_temp.bat
      ignore_errors: yes

    - name: Удалить временный BAT файл
      win_file:
        path: C:\Windows\Temp\clear_all_users_temp.bat
        state: absent
