---
- name: Clear TEMP folders for all users on Windows (without closing apps) with size logging
  hosts: all
  gather_facts: no
  tasks:

    - name: Create BAT file to clear TEMP folders with logging
      win_copy:
        dest: C:\Windows\Temp\clear_all_users_temp.bat
        content: |
          @echo off
          setlocal EnableDelayedExpansion

          set LOGFILE=C:\Windows\Temp\temp_cleanup.log
          echo ================================= > %LOGFILE%
          echo TEMP cleanup started at %DATE% %TIME% >> %LOGFILE%
          echo ================================= >> %LOGFILE%
          echo. >> %LOGFILE%

          set TOTALFILES=0
          set TOTALSIZE=0

          echo Processing user profiles...
          for /d %%U in (C:\Users\*) do (
              echo -------------------------------
              echo Cleaning profile: %%U
              
              if exist "%%U\AppData\Local\Temp" call :CleanFolder "%%U\AppData\Local\Temp"
              if exist "%%U\AppData\Local\Microsoft\Windows\INetCache" call :CleanFolder "%%U\AppData\Local\Microsoft\Windows\INetCache"
              if exist "%%U\AppData\Local\Microsoft\Windows\Temporary Internet Files" call :CleanFolder "%%U\AppData\Local\Microsoft\Windows\Temporary Internet Files"
          )

          echo.
          echo Cleaning system TEMP...
          if exist "C:\Windows\Temp" call :CleanFolder "C:\Windows\Temp"

          echo. >> %LOGFILE%
          echo TOTAL FILES DELETED: !TOTALFILES! >> %LOGFILE%
          echo TOTAL SIZE DELETED: !TOTALSIZE! bytes >> %LOGFILE%
          echo TEMP cleanup finished at %DATE% %TIME% >> %LOGFILE%
          echo ================================= >> %LOGFILE%

          exit /b 0

          :CleanFolder
          set FOLDER=%~1
          if exist "%FOLDER%" (
              echo Cleaning %FOLDER%
              attrib -r -s -h "%FOLDER%\*" /s /d >nul 2>&1

              :: Loop over files recursively to sum size and count
              for /r "%FOLDER%" %%F in (*) do (
                  set /a TOTALFILES+=1
                  for %%S in (%%F) do set /a TOTALSIZE+=%%~zS
                  del /f /q "%%F" >nul 2>&1
              )

              :: Delete subfolders recursively
              for /d %%D in ("%FOLDER%\*") do rd /s /q "%%D" >nul 2>&1
          )
          exit /b 0

    - name: Run the BAT file
      win_shell: C:\Windows\Temp\clear_all_users_temp.bat
      ignore_errors: yes

    - name: Delete temporary BAT file
      win_file:
        path: C:\Windows\Temp\clear_all_users_temp.bat
        state: absent
