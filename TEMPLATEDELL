---
- name: Принудительное выключение и удаление ВМ на PX03 (201–210)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    api_user: "ansible@pve"
    api_password: "Pharacia_"
    api_host: "172.16.10.5"
    node: "PX03"
    clones_to_delete: "{{ range(201, 211) | list }}"  # список от 201 до 210 включительно

  tasks:
    - name: Форсированное выключение ВМ перед удалением
      community.proxmox.proxmox_kvm:
        api_user: "{{ api_user }}"
        api_password: "{{ api_password }}"
        api_host: "{{ api_host }}"
        validate_certs: no
        node: "{{ node }}"
        vmid: "{{ item }}"
        state: stopped
        force: yes
      loop: "{{ clones_to_delete }}"
      register: shutdown_result
      failed_when: >
        shutdown_result is failed and
        ('does not exist' not in (shutdown_result.msg | default('')))

    - name: Удаление ВМ с дисками
      community.proxmox.proxmox_kvm:
        api_user: "{{ api_user }}"
        api_password: "{{ api_password }}"
        api_host: "{{ api_host }}"
        validate_certs: no
        node: "{{ node }}"
        vmid: "{{ item }}"
        state: absent
        purge: yes
      loop: "{{ clones_to_delete }}"
      register: delete_result
      failed_when: >
        delete_result is failed and
        ('does not exist' not in (delete_result.msg | default('')))
