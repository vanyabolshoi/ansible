---
- name: Принудительное убийство двух ВМ на PX03
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    api_user: "ansible@pve"
    api_password: "Pharacia_"
    api_host: "172.16.10.5"
    node: "PX03"

    vms_to_hard_stop:
      - 201
      - 202

  tasks:
    - name: Принудительное выключение ВМ через 'kill'
      community.proxmox.proxmox_kvm:
        api_user: "{{ api_user }}"
        api_password: "{{ api_password }}"
        api_host: "{{ api_host }}"
        validate_certs: no
        node: "{{ node }}"
        vmid: "{{ item }}"
        state: stopped
        force: yes
        skip_pending_checks: yes
        timeout: 30
        # Для жесткого завершения можно использовать "shutdown: hard" в старых версиях, но в community.proxmox это просто force + timeout
      loop: "{{ vms_to_hard_stop }}"
