---
- name: Проверить Windows 11 и наличие KB5066793
  hosts: all
  gather_facts: no
  vars:
    kb_id: KB5066793
    found_hosts: []
    not_found_hosts: []

  tasks:

    - name: Проверить доступность WinRM (таймаут 5 сек)
      ansible.windows.win_ping:
      register: ping_result
      ignore_errors: yes

    - name: Пропустить недоступные хосты
      meta: end_host
      when: ping_result is failed

    - name: Получить информацию о системе через systeminfo
      ansible.windows.win_shell: systeminfo
      register: sysinfo_raw

    - name: Вывести версию Windows
      debug:
        msg: "{{ inventory_hostname }} — {{ sysinfo_raw.stdout_lines | select('search','OS Name') | list }}, {{ sysinfo_raw.stdout_lines | select('search','OS Version') | list }}"

    - name: Проверить наличие KB5066793 (только если Windows 11)
      ansible.windows.win_shell: |
        $kb = Get-HotFix -Id {{ kb_id }} -ErrorAction SilentlyContinue
        if ($kb) { Write-Output "FOUND" } else { Write-Output "NOT_FOUND" }
      register: kb_check
      failed_when: false
      when: sysinfo_raw.stdout is search('Windows 11')

    - name: Добавить хост в соответствующий список
      set_fact:
        found_hosts: "{{ found_hosts + [inventory_hostname] }}"
      when: kb_check.stdout is search('FOUND')

    - name: Добавить хост в список отсутствующих (только если KB не найден)
      set_fact:
        not_found_hosts: "{{ not_found_hosts + [inventory_hostname] }}"
      when: kb_check.stdout is search('NOT_FOUND')

    - name: Сводный отчёт
      debug:
        msg: |
          🧾 Отчёт по проверке KB {{ kb_id }}:
          ✅ Установлено на: {{ found_hosts | join(', ') if found_hosts | length > 0 else 'нет' }}
          ❌ Отсутствует на: {{ not_found_hosts | join(', ') if not_found_hosts | length > 0 else 'нет' }}
