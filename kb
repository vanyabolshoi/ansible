---
- name: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Windows 11 Ð¸ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ KB5066793
  hosts: all
  gather_facts: no
  vars:
    kb_id: KB5066793
    found_hosts: []
    not_found_hosts: []

  tasks:

    - name: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ WinRM (Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 5 ÑÐµÐº)
      ansible.windows.win_ping:
      register: ping_result
      ignore_errors: yes

    - name: ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ñ…Ð¾ÑÑ‚Ñ‹
      meta: end_host
      when: ping_result is failed

    - name: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ Ñ‡ÐµÑ€ÐµÐ· systeminfo
      ansible.windows.win_shell: systeminfo
      register: sysinfo_raw

    - name: Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ Ð²ÐµÑ€ÑÐ¸ÑŽ Windows
      debug:
        msg: "{{ inventory_hostname }} â€” {{ sysinfo_raw.stdout_lines | select('search','OS Name') | list }}, {{ sysinfo_raw.stdout_lines | select('search','OS Version') | list }}"

    - name: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ KB5066793 (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Windows 11)
      ansible.windows.win_shell: |
        $kb = Get-HotFix -Id {{ kb_id }} -ErrorAction SilentlyContinue
        if ($kb) { Write-Output "FOUND" } else { Write-Output "NOT_FOUND" }
      register: kb_check
      failed_when: false
      when: sysinfo_raw.stdout is search('Windows 11')

    - name: Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ…Ð¾ÑÑ‚ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº
      set_fact:
        found_hosts: "{{ found_hosts + [inventory_hostname] }}"
      when: kb_check.stdout is search('FOUND')

    - name: Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ…Ð¾ÑÑ‚ Ð² ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ KB Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½)
      set_fact:
        not_found_hosts: "{{ not_found_hosts + [inventory_hostname] }}"
      when: kb_check.stdout is search('NOT_FOUND')

    - name: Ð¡Ð²Ð¾Ð´Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚
      debug:
        msg: |
          ðŸ§¾ ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¿Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ KB {{ kb_id }}:
          âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð½Ð°: {{ found_hosts | join(', ') if found_hosts | length > 0 else 'Ð½ÐµÑ‚' }}
          âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð½Ð°: {{ not_found_hosts | join(', ') if not_found_hosts | length > 0 else 'Ð½ÐµÑ‚' }}
