---
- name: Проверить Windows 11 и наличие KB5066793
  hosts: all
  gather_facts: no
  vars:
    kb_id: KB5066793
    found_hosts: []
    not_found_hosts: []

  tasks:

    - name: Проверить доступность WinRM (таймаут 5 сек)
      ansible.windows.win_ping:
      register: ping_result
      ignore_errors: yes

    - name: Пропустить недоступные хосты
      meta: end_host
      when: ping_result is failed

    - name: Получить информацию о системе через systeminfo
      ansible.windows.win_shell: systeminfo
      register: sysinfo_raw

    - name: Вывести версию Windows
      debug:
        msg: "{{ inventory_hostname }} — {{ sysinfo_raw.stdout_lines | select('search','OS Name') | list }}, {{ sysinfo_raw.stdout_lines | select('search','OS Version') | list }}"

    - name: Проверить наличие обновления KB5066793
      ansible.windows.win_powershell:
        script: |
          $kb = Get-HotFix | Where-Object {$_.HotFixID -eq "{{ kb_id }}"}
          if ($kb) { Write-Output "FOUND" }
      register: kb_check
      ignore_errors: yes

    - name: Сообщить результат
      debug:
        msg: >
          {{ '✅ ' + inventory_hostname + ' — KB5066793 установлено' if 'FOUND' in kb_check.stdout
             else '❌ ' + inventory_hostname + ' — KB5066793 не найдено' }}
