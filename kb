---
- name: Проверить Windows 11 и наличие KB5066793 через systeminfo
  hosts: all
  gather_facts: no
  vars:
    timeout_seconds: 5

  tasks:
    - name: Проверить доступность WinRM (таймаут 5 сек)
      ansible.builtin.wait_for:
        host: "{{ inventory_hostname }}"
        port: 5985
        timeout: "{{ timeout_seconds }}"
      delegate_to: localhost
      register: ping_result
      ignore_errors: yes

    - name: Пропустить недоступные хосты
      ansible.builtin.meta: end_host
      when: ping_result is failed

    - name: Получить информацию о системе
      ansible.windows.win_shell: |
        systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
      register: sysinfo_raw

    - name: Вывести версию Windows
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} — {{ sysinfo_raw.stdout_lines | join(', ') }}"

    - name: Проверить наличие KB5066793 (только если Windows 11)
      ansible.windows.win_shell: |
        Get-HotFix -Id KB5066793 -ErrorAction SilentlyContinue
      register: kb11
      when: sysinfo_raw.stdout is search('Windows 11')

    - name: Вывести IP если KB найден
      ansible.builtin.debug:
        msg: "✅ {{ inventory_hostname }} — KB5066793 установлено"
      when:
        - sysinfo_raw.stdout is search('Windows 11')
        - kb11.stdout is defined
        - kb11.stdout | trim != ''

    - name: Вывести IP если KB отсутствует
      ansible.builtin.debug:
        msg: "❌ {{ inventory_hostname }} — KB5066793 не найдено"
      when:
        - sysinfo_raw.stdout is search('Windows 11')
        - kb11.stdout is defined
        - kb11.stdout | trim == ''
