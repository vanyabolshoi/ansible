---
- name: Проверить Windows 11 и наличие KB5066793
  hosts: all
  gather_facts: no
  vars:
    timeout_seconds: 5

  tasks:
    - name: Проверить доступность хоста (таймаут 5 сек)
      ansible.builtin.wait_for:
        host: "{{ inventory_hostname }}"
        port: 5985
        timeout: "{{ timeout_seconds }}"
      register: ping_result
      ignore_errors: yes

    - name: Пропустить недоступные хосты
      ansible.builtin.meta: end_host
      when: ping_result is failed

    - name: Получить ProductName Windows
      ansible.windows.win_shell: |
        (Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion').ProductName
      register: os_name_raw

    - name: Нормализовать ProductName
      set_fact:
        os_name: "{{ os_name_raw.stdout | trim }}"

    - name: Проверить наличие KB5066793 (только если Windows 11)
      ansible.windows.win_shell: |
        Get-HotFix -Id KB5066793 -ErrorAction SilentlyContinue
      register: kb11
      when: "'Windows 11' in os_name"

    - name: Вывести IP если KB найден
      ansible.builtin.debug:
        msg: "✅ {{ inventory_hostname }} — KB5066793 установлено ({{ os_name }})"
      when:
        - "'Windows 11' in os_name"
        - kb11 is defined
        - kb11.stdout is defined
        - kb11.stdout | trim != ''

    - name: Вывести IP если KB отсутствует
      ansible.builtin.debug:
        msg: "❌ {{ inventory_hostname }} — KB5066793 не найдено ({{ os_name }})"
      when:
        - "'Windows 11' in os_name"
        - kb11 is defined
        - (kb11.stdout | trim == '') or (kb11.rc != 0)
