---
- name: Find users who have not logged in since 2026
  hosts: windows
  gather_facts: no

  tasks:

    - name: Get users with last logon before 2026
      win_shell: |
        $limitDate = Get-Date "2026-01-01"

        @(
          Get-LocalUser |
          Where-Object {
              $_.Enabled -eq $true -and
              $_.Name -notin @('Administrator','DefaultAccount','Guest') -and
              $_.LastLogon -lt $limitDate
          } |
          Select-Object -ExpandProperty Name
        ) | ConvertTo-Json

      register: old_users

    - name: Show result if there are old users
      debug:
        msg: >-
          {{
            [{ 'host': inventory_hostname, 'users': old_users.stdout | default('[]') | from_json }] 
            if old_users.stdout | default('') != '' else []
          }}
