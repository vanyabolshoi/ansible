---
- name: Find users who have not logged in since 2024
  hosts: windows
  gather_facts: no

  tasks:

    - name: Get user profiles not used since 2024
      win_shell: |
        $limitDate = Get-Date "2024-01-01"

        Get-CimInstance Win32_UserProfile |
        Where-Object {
            $_.Special -eq $false -and
            $_.LastUseTime -ne $null -and
            ([Management.ManagementDateTimeConverter]::ToDateTime($_.LastUseTime) -lt $limitDate)
        } |
        Select-Object LocalPath,
            @{Name="LastUsed";Expression={[Management.ManagementDateTimeConverter]::ToDateTime($_.LastUseTime)}} |
        Sort-Object LastUsed |
        Format-Table -AutoSize

      register: old_users

    - name: Show result
      debug:
        var: old_users.stdout_lines
