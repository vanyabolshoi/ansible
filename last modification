---
- name: Find all users who have not logged in since 2026
  hosts: windows
  gather_facts: no
  tasks:

    - name: Get users with last logon before 2026
      win_shell: |
        $limitDate = Get-Date "2026-01-01"

        @(
          Get-LocalUser |
          Where-Object {
              $_.Enabled -eq $true -and
              $_.Name -notin @('Administrator','DefaultAccount','Guest') -and
              $_.LastLogon -lt $limitDate
          } |
          Select-Object -ExpandProperty Name
        ) | ConvertTo-Json
      register: old_users

    - name: Add old users to a host fact
      set_fact:
        old_users_host: "{{ old_users.stdout | default('[]') | from_json }}"
      when: old_users.stdout | default('') != ''

- name: Combine all old users on localhost
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Gather old users from all hosts
      set_fact:
        old_users_all: >-
          {{
            groups['windows'] |
            map('extract', hostvars, 'old_users_host') |
            select('defined') |
            zip(groups['windows']) |
            map('reverse') |
            map('list') |
            map('combine', [{'host': item[1], 'users': item[0]}]) |
            list
          }}

    - name: Display combined list
      debug:
        var: old_users_all
