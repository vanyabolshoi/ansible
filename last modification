---
- name: Find users who have not logged in since 2024 with size
  hosts: windows
  gather_facts: no

  tasks:

    - name: Get old user folders with size
      win_shell: |
        $limitDate = Get-Date "2024-01-01"

        Get-ChildItem C:\Users -Directory |
        Where-Object {
            $_.Name -notin @('Public','Default','Default User','All Users','Administrator') -and
            $_.LastWriteTime -lt $limitDate
        } |
        ForEach-Object {

            $size = (Get-ChildItem $_.FullName -Recurse -Force -ErrorAction SilentlyContinue |
                     Measure-Object -Property Length -Sum).Sum

            [PSCustomObject]@{
                UserFolder = $_.FullName
                LastWrite  = $_.LastWriteTime
                SizeGB     = "{0:N2}" -f ($size / 1GB)
            }
        } |
        Sort-Object LastWrite |
        Format-Table -AutoSize

      register: old_users

    - name: Show result
      debug:
        var: old_users.stdout_lines
