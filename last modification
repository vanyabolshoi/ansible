---
- name: Find all users who have not logged in since 2026
  hosts: windows
  gather_facts: no
  vars:
    old_users_all: []

  tasks:

    - name: Get users with last logon before 2026
      win_shell: |
        $limitDate = Get-Date "2026-01-01"

        @(
          Get-LocalUser |
          Where-Object {
              $_.Enabled -eq $true -and
              $_.Name -notin @('Administrator','DefaultAccount','Guest') -and
              $_.LastLogon -lt $limitDate
          } |
          Select-Object -ExpandProperty Name
        ) | ConvertTo-Json

      register: old_users

    - name: Add old users from this host to the global list
      set_fact:
        old_users_all: "{{ old_users_all + [{'host': inventory_hostname, 'users': old_users.stdout | default('[]') | from_json}] }}"
      when: old_users.stdout | default('') != ''

- name: Show all old users from all hosts
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display combined list
      debug:
        var: old_users_all
