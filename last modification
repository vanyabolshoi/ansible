---
- name: Find users who have not logged in since 2024 with fast size calc
  hosts: windows
  gather_facts: no

  tasks:

    - name: Get old user folders with size (fast)
      win_shell: |
        $limitDate = Get-Date "2024-01-01"

        Get-ChildItem C:\Users -Directory |
        Where-Object {
            $_.Name -notin @('Public','Default','Default User','All Users','Administrator') -and
            $_.LastWriteTime -lt $limitDate
        } |
        ForEach-Object {

            $folder = $_.FullName

            $robocopy = robocopy $folder NULL /L /S /NJH /NJS /BYTES /NC /NDL /NFL 2>$null
            $bytes = ($robocopy | Select-String "Bytes :").ToString().Split(":")[1].Trim()

            if (-not $bytes) { $bytes = 0 }

            [PSCustomObject]@{
                UserFolder = $folder
                LastWrite  = $_.LastWriteTime
                SizeGB     = "{0:N2}" -f ([int64]$bytes / 1GB)
            }
        } |
        Sort-Object LastWrite |
        Format-Table -AutoSize

      register: old_users

    - name: Show result
      debug:
        var: old_users.stdout_lines
