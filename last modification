- name: Find users who have not logged in since 2026
  hosts: windows
  gather_facts: no
  tasks:

    - name: Get users with last logon before 2026
      win_shell: |
        $limitDate = Get-Date "2026-01-01"

        @(
          Get-LocalUser |
          Where-Object {
              $_.Enabled -eq $true -and
              $_.Name -notin @('Administrator','DefaultAccount','Guest') -and
              $_.LastLogon -lt $limitDate
          } |
          Select-Object Name, @{Name='LastLogon';Expression={$_.LastLogon}} 
        ) | ConvertTo-Json
      register: old_users

    - name: Set fact for old users if any
      set_fact:
        old_users_host: "{{ old_users.stdout | default('[]') | from_json }}"
      when: old_users.stdout | default('') != ''

- name: Combine all old users on localhost
  hosts: localhost
  gather_facts: no
  tasks:

    - name: Gather all old users from all hosts
      set_fact:
        old_users_all: >-
          {{
            groups['windows']
            | map('extract', hostvars, 'old_users_host')
            | select('defined')
            | zip(groups['windows'])
            | map('reverse')
            | map('list')
            | map('community.general.dict_kv', 'host', 'users')
            | selectattr('users', 'truthy')
            | list
          }}

    - name: Display combined list
      debug:
        var: old_users_all
