- name: Find users who have not logged in since 2026
  hosts: windows
  gather_facts: no
  tasks:

    - name: Get users with last logon before 2026
      win_shell: |
        $limitDate = Get-Date "2026-01-01"

        @(
          Get-LocalUser |
          Where-Object {
              $_.Enabled -eq $true -and
              $_.Name -notin @('Administrator','DefaultAccount','Guest') -and
              $_.LastLogon -lt $limitDate
          } |
          Select-Object Name
        ) | ForEach-Object { $_.Name } | ConvertTo-Json
      register: old_users

    - name: Set fact for old users if any
      set_fact:
        old_users_host: "{{ old_users.stdout | from_json }}"
      when: old_users.stdout | default('') != ''

- name: Show all old users from all hosts
  hosts: localhost
  gather_facts: no
  tasks:

    - name: Combine old users from all hosts
      set_fact:
        old_users_all: >-
          {{
            groups['windows']
            | map('extract', hostvars, 'old_users_host')
            | zip(groups['windows'])
            | map('reverse')
            | map('list')
            | selectattr(0, 'defined')
            | map('community.general.json_query', '[1] & {"host": @[1], "users": @[0]}')
            | list
          }}

    - name: Display combined list
      debug:
        var: old_users_all
